pipeline {
    agent any

    stages {

        stage('stg1-2820275g') {
            steps {
                echo "stg1-2820275g: Both testsvr_2820275g & appsvr_2820275g preparation check pass."
            }
        }
 
		stage('stg2-2820275g') {
			steps {
				script {
					def testsvrUrl = 'http://192.168.150.210:80'  
					
					// Run curl and capture result
					def response = sh(
						script: "curl -s -o /dev/null -w \"%{http_code}\" ${testsvrUrl}",
						returnStdout: true
					).trim()

					// Check if HTTP response is 200
					if (response == '200') {
						echo "stg2_2820275g: testsvr’s website is running"
						
						// Prompt user to proceed
						def proceed = input(
							message: 'Proceed to update testsvr server?',
							parameters: [
								[$class: 'BooleanParameterDefinition', defaultValue: true, description: '', name: 'Proceed']
							]
						)
						
						if (proceed) {
							echo "Proceeding to Stage 3..."
							// Set a flag to allow Stage 3
							env.STAGE2_OK = "true"
						} else {
							echo "User chose NOT to proceed. Aborting pipeline."
							error("Pipeline aborted by user at Stage 2")
						}
						
					} else {
						echo "stg2_2820275g: testsvr’s website is down"
						error("Pipeline aborted because testsvr is down")
					}
				}
			}
		}
		stage('stg3-2820275g') {
			steps {
				script {

					echo "Checking and removing old backup image (if exists)..."

					sh '''
					if docker images -q testsvr_image | grep -q .; then
						echo "Old backup image found. Removing..."
						docker rmi -f testsvr_image
					else
						echo "No old backup image found."
					fi
					'''

					echo "Creating new backup image from testsvr_2820275g..."
					sh 'docker commit testsvr_2820275g testsvr_image'

					echo "Updating index.html inside container..."

					sh '''
					docker exec testsvr_2820275g sh -c "echo 'Updated by stg3_2820275g' > /usr/share/apache2/default-site/index.html"
					'''

					echo "stg3_testsvr_2820275g: testsvr_2820275g is backup and updated"
				}
			}
		}
		stage('stg4-2820275g') {
			steps {
				script {

					echo "Checking if testsvr_2820275g website is running..."

					def testsvrUrl = 'http://192.168.150.210:80'

					// Run curl and capture HTTP status code
					def response = sh(
						script: "curl -s -o /dev/null -w '%{http_code}' ${testsvrUrl}",
						returnStdout: true
					).trim()

					echo "HTTP Response Code: ${response}"

					if (response == '200') {

						echo "stg4_2820275g_: testsvr’s website is running after update"

						// Manual confirmation before Stage 5
						input message: "Proceed to update appsvr server?"

					} else {

						echo "stg4_2820275g_: testsvr’s website is down"

						error("Aborting pipeline because testsvr_2820275g is down.")
					}
				}
			}
		}
		
		stage('stg5-2820275g') {
			steps {
				script {

					echo "Checking and removing old backup image (if exists)..."

					// Remove old backup image if exists
					sh '''
					if docker images -q appsvr_image | grep -q .; then
						echo "Old backup image found. Removing..."
						docker rmi -f appsvr_image
					else
						echo "No old backup image found."
					fi
					'''

					echo "Creating new backup image from appsvr_2820275g..."

					// Create new backup image
					sh 'docker commit appsvr_2820275g appsvr_image'

					echo "Updating index.html inside appsvr container..."

					// Update index.html inside container
					sh '''
					docker exec appsvr_2820275g sh -c "echo 'Updated by stg5_2820275g' > /usr/share/apache2/default-site/index.html"
					'''

					echo "stg5_2820275g: appsvr_2820275g web server is backup and updated"
				}
			}
		}
		stage('stg6-2820275g') {
			steps {
				script {

					echo "Performing web test for testsvr_2820275g..."

					// Test testsvr and save first HTTP header line
					sh 'curl -Is http://192.168.150.210:80 | head -n 1 > /tmp/testsvr-result-file'

					echo "Checking testsvr-result-file..."
					def testsvr_result = sh(script: 'cat /tmp/testsvr-result-file', returnStdout: true).trim()
					echo "testsvr-result-file content: ${testsvr_result}"

					echo "Performing web test for appsvr_2820275g..."

					// Test appsvr and save first HTTP header line
					sh 'curl -Is http://192.168.160.220:80 | head -n 1 > /tmp/appsvr-result-file'

					echo "Checking appsvr-result-file..."
					def appsvr_result = sh(script: 'cat /tmp/appsvr-result-file', returnStdout: true).trim()
					echo "appsvr-result-file content: ${appsvr_result}"

					// Evaluate appsvr status
					if (appsvr_result.contains("200 OK")) {
						echo "stg6_2820275g: appsvr website is operational"
					} else {

						// Prompt user for action if appsvr is down
						def userChoice = input(
							message: "Appsvr is down. Choose action:",
							parameters: [
								choice(
									choices: ['Trigger roll back', 'Troubleshooting'],
									description: 'Select action',
									name: 'ACTION'
								)
							]
						)

						if (userChoice == "Trigger roll back") {
							echo "stg6_2820275g: Production website is rolling back"
						} else if (userChoice == "Troubleshooting") {
							echo "stg6_2820275g: Troubleshooting of Production website starts"
						}
					}

					echo "Stage 6 completed. Pipeline ends here."
				}
			}
		}	
	}
}
